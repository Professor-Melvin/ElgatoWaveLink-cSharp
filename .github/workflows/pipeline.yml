name: Pipeline

on:
    workflow_dispatch:
        inputs:
            version:
                required: true
                description: Input version for this build

    push:
        branches: ["main"]
        paths-ignore:
            - '**/*.md'
            - '**/*.gitignore'
            - '**/*.gitattributes'
    pull_request:
        branches: ["main"]
        paths-ignore:
            - '**/*.md'
            - '**/*.gitignore'
            - '**/*.gitattributes'

env:
    isPrComplete: ${{ github.event.pull_request.merged == true }}
    isPr: ${{ github.event_name == 'pull_request' }}
    betaVersion:  beta

#Not sure if I want this to cancel the previous build yet
#concurrency:
#  group: ${{ github.workflow }}-${{ github.ref }}
#  cancel-in-progress: true

jobs:
    build:
        name: Build
        runs-on: windows-latest
        environment:
            name: beta
        steps:
            - uses: actions/checkout@v3

            - name: Ensure Version Change
              shell: pwsh
              run: |
                 .\VersionCheck.ps1

            - name: Setup .Net
              uses: actions/setup-dotnet@v2
              with:
                dotnet-version: 6.x

            - name: Restore
              run: dotnet restore

            - name: Build Beta
              run: dotnet build --configuration Release --no-restore --version-suffix ${{ env.betaVersion }}

            - name: Test
              run: dotnet test --no-build -c Release --no-restore --collect "Code coverage" --blame

            - name: Upload Artifacts
              uses: actions/upload-artifact@v3
              with:
                name: artifact
                if-no-files-found: error
                retention-days: 5
                path: |
                    ElgatoWaveAPI/bin/Release/net6.0/
                    ElgatoWaveAPI/bin/Release/*.nupkg
              
            - name: Publish 
              if: ${{ env.isPrComplete }}
              run: dotnet nuget push "ElgatoWaveAPI\bin\Release\*.nupkg" --api-key ${{secrets.NUGETAPI}} --no-symbols --skip-duplicate --source https://api.nuget.org/v3/index.json

    release:
        name: Release
        if: ${{ !isPr }}
        runs-on: windows-latest
        needs: build
        environment:
            name: release
        steps:
            - uses: actions/checkout@v3

            - name: Ensure Version Change
              shell: pwsh
              run: |
                 .\VersionCheck.ps1

            - name: Setup .Net
              uses: actions/setup-dotnet@v2
              with:
                dotnet-version: 6.x

            - name: Restore
              run: dotnet restore

            - name: Build Release
              run: dotnet build --configuration Release --no-restore

            - name: Upload Artifacts
              uses: actions/upload-artifact@v3
              with:
                name: artifact
                if-no-files-found: error
                retention-days: 5
                path: |
                    ElgatoWaveAPI/bin/Release/net6.0/
                    ElgatoWaveAPI/bin/Release/*.nupkg
              
            - name: Publish
              run: dotnet nuget push "ElgatoWaveAPI\bin\Release\*.nupkg" --api-key ${{secrets.NUGETAPI}} --no-symbols --skip-duplicate --source https://api.nuget.org/v3/index.json